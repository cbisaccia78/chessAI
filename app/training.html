<!DOCTYPE html>
<html>

<head>

</head>

<body id = "body">




<svg id = "contain" width = "800" height = "800">
  <defs>
    <filter id = "f1" x = "0" y = "0">
      <feGaussianBlur in="SourceGraphic" stdDeviation="15" />
    </filter>

  </defs>

  <script>
    var container = document.getElementById("contain");
    var topLines = []
    var sideLines = []
    for (let i = 0; i < 8; i++){
      console.log('i: ',i);
      var topLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
      topLine.setAttribute("x1","0");
      topLine.setAttribute("y1", (i*100).toString());
      topLine.setAttribute("x2","800");
      topLine.setAttribute("y2", (i*100).toString());
      topLine.setAttribute("style","stroke:black");
      topLines[topLines.length] = topLine;

      for(let j = 0; j < 8; j++){
        console.log('j: ', j);
        var rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        if((i+j)%2==0){
          rect.setAttribute("style","fill:white;");
        }else{
          rect.setAttribute("style","fill:brown;");
        }
        var xNum = i * 100;
        var yNum = j * 100;
        rect.setAttribute("x", xNum.toString());
        rect.setAttribute("y", yNum.toString());
        rect.setAttribute("width", "100");
        rect.setAttribute("height", "100");
        container.appendChild(rect);
      }
    }

    for(let k = 0; k < 8; k++){
      var sideLine = document.createElementNS("http://www.w3.org/2000/svg","line");
      sideLine.setAttribute("x1",(k*100).toString());
      sideLine.setAttribute("y1", "0");
      sideLine.setAttribute("x2",(k*100).toString());
      sideLine.setAttribute("y2", "800");
      sideLine.setAttribute("style","stroke:black");
      container.appendChild(sideLine)
      sideLines[sideLines.length] = sideLine
      container.appendChild(sideLine);
      container.appendChild(topLines[k]);
    }


    var l = document.createElementNS("http://www.w3.org/2000/svg","line");
    var r = document.createElementNS("http://www.w3.org/2000/svg","line");
    var t = document.createElementNS("http://www.w3.org/2000/svg","line");
    var b = document.createElementNS("http://www.w3.org/2000/svg","line");

    l.setAttribute("x1","0");
    l.setAttribute("y1","0");
    l.setAttribute("x2","0");
    l.setAttribute("y2","800");
    l.setAttribute("style","stroke:black; stroke-width:3");

    r.setAttribute("x1","800");
    r.setAttribute("y1","0");
    r.setAttribute("x2","800");
    r.setAttribute("y2","800");
    r.setAttribute("style","stroke:black; stroke-width:3");

    t.setAttribute("x1","0");
    t.setAttribute("y1","0");
    t.setAttribute("x2","800");
    t.setAttribute("y2","0");
    t.setAttribute("style","stroke:black; stroke-width:3");

    b.setAttribute("x1","0");
    b.setAttribute("y1","800");
    b.setAttribute("x2","800");
    b.setAttribute("y2","800");
    b.setAttribute("style","stroke:black; stroke-width:3");

    container.appendChild(l);
    container.appendChild(r);
    container.appendChild(t);
    container.appendChild(b);



  </script>
  <image id = "a7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "0" y = "100"></image>
  <image id = "b7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "100" y = "100"></image>
  <image id = "c7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "200" y = "100"></image>
  <image id = "d7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "300" y = "100"></image>
  <image id = "e7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "400" y = "100"></image>
  <image id = "f7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "500" y = "100"></image>
  <image id = "g7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "600" y = "100"></image>
  <image id = "h7p" href = "http://174.129.83.34:80/images/Chess_pdt60.png" width = "100" height = "100" x = "700" y = "100"></image>
  <image id = "a8r" href = "http://174.129.83.34:80/images/Chess_rdt60.png" width = "100" height = "100" x = "0" y = "0"></image>
  <image id = "b8kn" href = "http://174.129.83.34:80/images/Chess_ndt60.png" width = "100" height = "100" x = "100" y = "0"></image>
  <image id = "c8b" href = "http://174.129.83.34:80/images/Chess_bdt60.png" width = "100" height = "100" x = "200" y = "0"></image>
  <image id = "d8q" href = "http://174.129.83.34:80/images/Chess_qdt60.png" width = "100" height = "100" x = "300" y = "0"></image>
  <image id = "e8k" href = "http://174.129.83.34:80/images/Chess_kdt60.png" width = "100" height = "100" x = "400" y = "0"></image>
  <image id = "f8b" href = "http://174.129.83.34:80/images/Chess_bdt60.png" width = "100" height = "100" x = "500" y = "0"></image>
  <image id = "g8kn" href = "http://174.129.83.34:80/images/Chess_ndt60.png" width = "100" height = "100" x = "600" y = "0"></image>
  <image id = "h8r" href = "http://174.129.83.34:80/images/Chess_rdt60.png" width = "100" height = "100" x = "700" y = "0"></image>

  <image id = "a2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "0" y = "600"></image>
  <image id = "b2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "100" y = "600"></image>
  <image id = "c2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "200" y = "600"></image>
  <image id = "d2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "300" y = "600"></image>
  <image id = "e2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "400" y = "600"></image>
  <image id = "f2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "500" y = "600"></image>
  <image id = "g2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "600" y = "600"></image>
  <image id = "h2p" href = "http://174.129.83.34:80/images/Chess_plt60.png" width = "100" height = "100" x = "700" y = "600"></image>
  <image id = "a1r" href = "http://174.129.83.34:80/images/Chess_rlt60.png" width = "100" height = "100" x = "0" y = "700"></image>
  <image id = "b1kn" href = "http://174.129.83.34:80/images/Chess_nlt60.png" width = "100" height = "100" x = "100" y = "700"></image>
  <image id = "c1b" href = "http://174.129.83.34:80/images/Chess_blt60.png" width = "100" height = "100" x = "200" y = "700"></image>
  <image id = "d1q" href = "http://174.129.83.34:80/images/Chess_qlt60.png" width = "100" height = "100" x = "300" y = "700"></image>
  <image id = "e1k" href = "http://174.129.83.34:80/images/Chess_klt60.png" width = "100" height = "100" x = "400" y = "700"></image>
  <image id = "f1b" href = "http://174.129.83.34:80/images/Chess_blt60.png" width = "100" height = "100" x = "500" y = "700"></image>
  <image id = "g1kn" href = "http://174.129.83.34:80/images/Chess_nlt60.png" width = "100" height = "100" x = "600" y = "700"></image>
  <image id = "h1r" href = "http://174.129.83.34:80/images/Chess_rlt60.png" width = "100" height = "100" x = "700" y = "700"></image>
</svg>




<script type = "module">
import {Game, Pawn, Rook, Knight, Bishop, Queen} from "http://174.129.83.34:80/js/StateManager.js"; //statemanager.js import
var chessGame = new Game("5","cole","computer");
chessGame.printGame();

var timer = null;
var clicked = false;
var currentImageUrl;
var currentImage;
var id;
var lastX = 0;
var lastY = 0;
var _piece;
var cont = document.getElementById("contain");
var promContain;
var checkM = false;
var promotedPiece;
var promotedNum = 0;
var promoted = false;



function sleep(milliseconds) {
  const date = Date.now();
  let currentDate = null;
  do {
    currentDate = Date.now();
  } while (currentDate - date < milliseconds);
}

function promotionBitboard(game){

}

function promotion(){





  var rookP = new Rook(`${piece.color}`, `rook`, piece.location);
  var knightP = new Knight(`${piece.color}`, `knight`, piece.location);
  var bishopP = new Bishop(`${piece.color}`, `bishop`, piece.location);
  var queenP = new Queen(`${piece.color}`, `queen`, piece.location);
  var moves = [];
  moves.push(rookP);
  moves.push(knightP);
  moves.push(bishopP);
  moves.push(queenP);


  //console.log(bitboard);


  var i;
  var bestHSoFar = 0;
  var bestMoveSoFar = 0;
  for(i = 0; i < moves.length; i++){
    var gameCopy = game.deepCopy();
    //console.log(gameCopy);
    gameCopy.game[moves[i].location[1]][moves[i].location[0]] = moves[i].deepCopy();
    //console.log(newGame);
    var bitboard = [];
    for(var i = 0; i < 8; i++){
      row = [];
      for(var j = 0; j < 8; j++){
        row.push(pieceConversion(gameCopy.game[i][j]));
      }
      bitboard.push(row);
    }

    //console.log(bitboard);
    var eval = sigmoidNet.forwardProp(bitboard);
    if(eval > bestHSoFar){
      bestHSoFar = eval;
      bestMoveSoFar = [];
      bestMoveSoFar.push(i);
    }
    if(eval == bestHSoFar){
      bestHSoFar = eval;
      bestMoveSoFar.push(i);
    }
  }

  var promotedPiece = moves[bestMoveSoFar[Math.floor((Math.random()*bestMoveSoFar.length-1) +1)]];
  promotedNum += 1;
  if(promotedPiece.name == "rook"){
    promotedPiece.id = `pr${promotedNum}`;
  }else if(promotedPiece.name == "knight"){
    promotedPiece.id = `pn${promotedNum}`;
  }else if(promotedPiece.name == "bishop"){
    promotedPiece.id = `pb${promotedNum}`;
  }else if(promotedPiece.name == "queen"){
    promotedPiece.id = `pq${promotedNum}`;
  }else{
    console.log('error');
  }


  game.promotions.push(promotedPiece.deepCopy());
  if(promotedPiece.color == game.p1.color){
    game.p1.pieces.push(promotedPiece.deepCopy())
  }else{
    game.p2.pieces.push(promotedPiece.deepCopy())
  }

  game.game[promotedPiece.location[1]][promotedPiece.location[0]] = promotedPiece.deepCopy();
  piece = promotedPiece.deepCopy();




  if(promotedPiece.color == "white"){
    document.body.removeChild(document.getElementById("wp"));
    document.body.removeChild(document.getElementById("wr"));
    document.body.removeChild(document.getElementById("wn"));
    document.body.removeChild(document.getElementById("wb"));
    document.body.removeChild(document.getElementById("wq"));
  }else{
    document.body.removeChild(document.getElementById("bp"));
    document.body.removeChild(document.getElementById("br"));
    document.body.removeChild(document.getElementById("bn"));
    document.body.removeChild(document.getElementById("bb"));
    document.body.removeChild(document.getElementById("bq"));
  }

  promoted = true;
  //cont.visibility = "visible";
  //check to see if new piece is check
  //also remove Pawn and set current image to the promoted piece;
  currentImage.setAttribute('href', piece.url);
  currentImage.setAttribute('id', piece.id);
  return;

}






function drop(){
  //clearInterval(timer)
  if(checkM == true){
    return;
  }

  var loc;

  var movingTo = moveDetails[1];

  var piece = moveDetails[2];
  var rook;
  if(moveDetails.length == 4){
    piece = moveDetails[3];
    rook = moveDetails[2];
  }

  var currentImageUrl = _piece.url;
  var id = _piece.id;
  var currentImage = document.getElementById(id);

  if(moveDetails[0] == true){
    document.getElementById(moveDetails[1]).setAttribute("style", "visibility:hidden");
  }

  var promotion = false;

  if(piece.name == "pawn" && (piece.color == "white" && baseY == 0)){
    console.log('pawn promition:');
    //set up selection
    var left = (piece.location[0])*100;
    var to = (piece.location[1])*100;

    //console.log(`left = ${left} top = ${to}`);


    //console.log('i');
    var pwn = document.createElement("img");
    //console.log('i');
    pwn.id = "wp";
    //console.log('i');
    pwn.src = "http://174.129.83.34:80/images/Chess_plt60.png";
    pwn.style = `position: absolute; top: ${to}px; left: ${left}px; z-index: 2`;
    pwn.width = "100";
    pwn.height = "100";
    //console.log('i');

    var rk = document.createElement("img");
    rk.id = "wr";
    rk.src = "http://174.129.83.34:80/images/Chess_rlt60.png";
    var rookL = left+100;
    rk.style = `position: absolute; top: ${to}px; left: ${rookL}px; z-index: 2`;
    rk.width = "100";
    rk.height = "100";

    var n = document.createElement("img");
    n.id = "wn";
    n.src = "http://174.129.83.34:80/images/Chess_nlt60.png";
    var nL = left+200;
    n.style = `position: absolute; top: ${to}px; left: ${nL}px; z-index: 2`;
    n.width = "100";
    n.height = "100";
    //console.log('i');

    var b = document.createElement("img");
    b.id = "wb";
    b.src = "http://174.129.83.34:80/images/Chess_blt60.png";
    var bL = left+300;
    b.style = `position: absolute; top: ${to}px; left: ${bL}px; z-index: 2`;
    b.width = "100";
    b.height = "100";



    var q = document.createElement("img");
    q.id = "wq";
    q.src = "http://174.129.83.34:80/images/Chess_qlt60.png";
    var qL = left+400;
    q.style = `position: absolute; top: ${to}px; left: ${qL}px; z-index: 2`;//520
    q.width = "100";
    q.height = "100";



    currentImage.setAttribute('x', ((_piece.location[0])*100).toString());
    currentImage.setAttribute('y', ((_piece.location[1])*100).toString());

    promotion();

    promotion = true;
    cont.disabled = true;


    return;


    //chessGame.pawnPromotions[_p] = true; //unsolved logic bug: this does not test whether or not pawn promotion puts itself in selfcheck.

  }
  if(_piece.name == "pawn" && (_piece.color == "black" && baseY == 7)){
    console.log('pawn promition:');
    //set up selection
    var left = (_piece.location[0])*100;
    var to = (_piece.location[1])*100;


    var pwn = document.createElement("img");
    pwn.id = "bp";
    pwn.src = "http://174.129.83.34:80/images/Chess_pdt60.png";
    pwn.style = `position: absolute; top: ${to}px; left: ${left}px; z-index: 2`;
    pwn.width = "100";
    pwn.height = "100";

    var rk = document.createElement("img");
    rk.id = "br";
    rk.src = "http://174.129.83.34:80/images/Chess_rdt60.png";
    rk.style = `position: absolute; top: ${to}px; left: ${left+100}; z-index: 2px`;
    rk.width = "100";
    rk.height = "100";

    var n = document.createElement("img");
    n.id = "bn";
    n.src = "http://174.129.83.34:80/images/Chess_ndt60.png";
    n.style = `position: absolute; top: ${to}px; left: ${left+200}px; z-index: 2`;
    n.width = "100";
    n.height = "100";

    var b = document.createElement("img");
    b.id = "bb";
    b.src = "http://174.129.83.34:80/images/Chess_bdt60.png";
    b.style = `position: absolute; top: ${to}px; left: ${left+300}px; z-index: 2`;
    b.width = "100";
    b.height = "100";

    var q = document.createElement("img");
    q.id = "bq";
    q.src = "http://174.129.83.34:80/images/Chess_qdt60.png";
    q.style = `position: absolute; top: ${to}px; left: ${left+400}px; z-index: 2`;//520
    q.width = "100";
    q.height = "100";

    document.body.appendChild(pwn);
    document.body.appendChild(rk);
    document.body.appendChild(n);
    document.body.appendChild(b);
    document.body.appendChild(q);
    currentImage.setAttribute('x', ((_piece.location[0])*100).toString());
    currentImage.setAttribute('y', ((_piece.location[1])*100).toString());
    document.getElementById("contain").removeEventListener("mousedown", dragStart);
    document.getElementById("contain").removeEventListener("mouseup", drop);
    document.getElementById("contain").removeEventListener("mouseover", dragEnter);
    document.getElementById("contain").removeEventListener("mouseout", dragLeave);
    document.getElementById("contain").removeEventListener("mousemove", dragging);
    document.addEventListener("mousedown",clickListener);





    promotion = true;
    cont.disabled = true;

    return;
    //chessGame.pawnPromotions[_p] = true; //unsolved logic bug: this does not test whether or not pawn promotion puts itself in selfcheck.

  }
  currentImage.setAttribute('x', ((piece.location[0])*100).toString());
  currentImage.setAttribute('y', ((piece.location[1])*100).toString());



  if(move.length == 4){
    console.log(`rook id = ${rook.id}`);
    var rookImage = document.getElementById(rook.id);
    rookImage.setAttribute('x', ((rook.location[0])*100).toString());
    rookImage.setAttribute('y', ((rook.location[1])*100).toString());
  }

  //if the drop is legal: then good
  //else, revert the img coordinates to go back to lastX, lastY
  console.log('drop!');
  clicked = false;
  checkM = chessGame.checkMate();
  if(checkM == true){
    //stop input and display game over stuff
    console.log(`checkmate`);
    var checkMateScreen = document.createElementNS("http://www.w3.org/2000/svg","rect");
    checkMateScreen.setAttribute('x', '200');
    checkMateScreen.setAttribute('y', '200');
    checkMateScreen.setAttribute('style', 'width: 400px; height: 400px; fill:blue;');
    cont.appendChild(checkMateScreen);
  }else{
    console.log(`not Checkmate`);
  }

  }






/*
while(!chessGame.checkMate()){
     var move = getMove(chessGame);
     chessGame.translateExecute(move);
     chessGame.printGame();
  }
*/


var signet = new SigmoidNet([[1,1,1]],[5,5],[1]);//try it with 1 hidden layer
//signet.forwardProp(signet.initialBitboard);


var game = new statemanager.Game("computer", "computer", 5);
var p = game.getPlayer(game.turn);
var count = 0;
var promotedNum = 0;
var move;
var moveDetails;

while(count < 10000){
  console.log(`count = ${count}`);
  move = getmove(game, signet);
  console.log(`chosen move is: `);
  console.log(move);
  var holder = game.movePieceUpdate(move);
  game = holder[0];
  moveDetails = holder[1];

  console.log(`justcastled = ${game.getKing().justCastled}`);
  count++;

}


</script>





</svg>

</body>
</html>
